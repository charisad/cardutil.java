name: Java CI with Maven

on:
  push:
    branches: [ "master" ]
    tags: [ "v*" ] # Triggers when you push a version tag
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    # Added permissions to allow the bot to commit the README change
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4 # Updated to v4 for better performance

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn -B package --file pom.xml

    # --- NEW STEP: Update README version on tag push ---
    - name: Update Version in README
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        NEW_VERSION=${GITHUB_REF#refs/tags/}
        # Replaces the version inside the <version> tag in README
        sed -i "s|<version>.*</version>|<version>${NEW_VERSION}</version>|g" README.md

    - name: Commit & Push README change
      if: startsWith(github.ref, 'refs/tags/')
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "docs: update README to version ${{ github.ref_name }}"
        file_pattern: 'README.md'
